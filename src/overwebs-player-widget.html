<script src="../gluon/gluon.js.min"></script>
<link rel="import" href="../overwebs-fonts/overwebs-fonts.html">

<template id="overwebs-player-widget-template">
  <style>
    :host {
      display: flex;
      position: absolute;
      top: calc(40 / 25.6 * 1vw);
      right: calc(68 / 25.6 * 1vw);
      height: calc(80 / 25.6 * 1vw);
      background: #27354F;
    }

    #status {
      height: 100%;
      width: calc(6 / 25.6 * 1vw);
      background: #7DFF00;
    }

    #avatar {
      height: 100%;
      width: calc(80 / 25.6 * 1vw);
      background-size: contain;
      background-repeat: no-repeat;
    }

    .player {
      line-height: 1;
      display: flex;
      align-items: center;
      color: white;
      height: 100%;
      width: calc(454 / 25.6 * 1vw);
    }

    #name {
      margin-left: calc(13 / 25.6 * 1vw);
      font-size: calc(24 / 25.6 * 1vw);
      margin-top: calc(1 / 25.6 * 1vw);
      letter-spacing: calc(0.3 / 25.6 * 1vw);;
      font-family: overwebs-helvetica;
      text-transform: uppercase;
    }

    #levelBox {
      height: calc(24 / 25.6 * 1vw);
      margin-left: calc(10 / 25.6 * 1vw);
      padding-left: calc(8 / 25.6 * 1vw);
      border-radius: calc(3 / 25.6 * 1vw);
      padding-right: calc(2 / 25.6 * 1vw);
      display: flex;
      align-items: center;
    }

    #level {
      font-size: calc(19 / 25.6 * 1vw);
      line-height: calc(24 / 25.6 * 1vw);
      padding-right: calc(6 / 25.6 * 1vw);
      font-family: overwebs-futura;
      color: white;
      transform: translateY(calc(1 / 25.6 * 1vw));
    }

    #prestige {
      display: inline-block;
      border-radius: calc(3 / 25.6 * 1vw);
      font-family: overwebs-futura;
      background: #FFFFFF;
      font-size: calc(24 / 25.6 * 1vw);
      line-height: calc(20 / 25.6 * 1vw);
    }
    #prestige .star {
      display: inline-block;
      transform: translateY(calc(1 / 25.6 * 1vw));
    }
    #prestige .star + .star {
      margin-left: calc(-2 / 25.6 * 1vw);
    }

    #levelBox.bronze {
      background: #A35435;
    }

    #levelBox.bronze #prestige {
      color: #A35435;
    }

    #levelBox.silver {
      background: silver; // TODO: fix placeholder
    }
    #levelBox.silver #prestige {
      color: silver; // TODO: fix placeholder
    }

    #levelBox.gold {
      background: gold; // TODO: fix placeholder
    }
    #levelBox.gold #prestige {
      color: gold; // TODO: fix placeholder
    }
  </style>
  <div id="status"></div>
  <div id="avatar"></div>
  <div class="player">
    <span id="name">[[_name(player)]]</span>
    <span id="levelBox">
      <span id="level">[[_level(player)]]</span>
      <span id="prestige">
        <!-- TODO: Create something to replace dom-repeat -->
        <template is="dom-repeat" items="[[_stars(player)]]" strip-whitespace>
          <!-- TODO: The futura font does not support the star glyph -->
          <span class="star">[[item]]</span>
        </template>
      </span>
    </span>
  </div>
</template>

<script>
  {
    let prestigeRanks = ['bronze', 'silver', 'gold']

    let doc;
    if (document._currentScript) {
      doc = document._currentScript.ownerDocument;
    } else {
      doc = document.currentScript.ownerDocument;
    }

    class OverwebsPlayerWidget extends Gluon.Element {
      static get _document() {
        return doc;
      }

      static get is() { return 'overwebs-player-widget' }

      set player(player) {
        if (player === undefined) {
          return;
        }
        if (player.avatar) {
          // TODO: Create an alternative for resolveUrl
          this.$.avatar.style.backgroundImage = 'url(' + this.resolveUrl(`avatars/${player.avatar}.png`) + ')';
        }
        this.$.levelBox.classList.remove(prestigeRanks); // TODO: Splat the args
        this.$.levelBox.classList.add(prestigeRanks[Math.trunc(player.level / 600)]);
        this.$.status.style.background = this._statusBackground(player);
      }

      _statusBackground(player) {
        switch(player.status) {
          case 'available': return '#7DFF00';
          case 'away': return 'yellow';
          case 'busy': return 'red';
          default: return '#7DFF00';
        }
      }

      _name(player) {
        return player.name || '';
      }

      _level(player) {
        return player.level && (player.level - 1) % 100 + 1 || 0;
      }

      _stars(player) {
        return player.level && Array.from('â˜…'.repeat(Math.trunc(((player.level % 600) - 1) / 100))) || [];
      }
    }

    customElements.define(OverwebsPlayerWidget.is, OverwebsPlayerWidget)
  }
</script>
